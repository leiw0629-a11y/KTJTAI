<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­çº§ä¸°æ”¶æ—¶åˆ» v15.0 (è¿›åº¦å¯è§†åŒ–ç‰ˆ)</title>
    <style>
        :root {
            /* èƒŒæ™¯ï¼šæ¸…é€è“å¤© */
            --bg-gradient: linear-gradient(180deg, #E1F5FE 0%, #FFFDE7 100%);
            
            /* æŒ‰é’®ï¼šé²œè‰³æœå†»è‰² (å¸¸äº®) */
            --btn-red-bg: linear-gradient(135deg, #FF5252, #FF1744);
            --btn-red-shadow: rgba(255, 23, 68, 0.4);
            
            --btn-green-bg: linear-gradient(135deg, #66BB6A, #43A047);
            --btn-green-shadow: rgba(67, 160, 71, 0.4);
            
            --btn-blue-bg: linear-gradient(135deg, #42A5F5, #1E88E5);
            --btn-blue-shadow: rgba(30, 136, 229, 0.4);
            
            --card-shadow: 0 10px 40px rgba(0,0,0,0.15);
        }

        body {
            margin: 0;
            height: 100vh;
            overflow: hidden;
            font-family: "Nunito", "Microsoft YaHei", sans-serif;
            background: var(--bg-gradient);
            user-select: none;
        }

        /* === é€šç”¨æ ·å¼ === */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 30px;
            text-align: center;
            box-shadow: var(--card-shadow);
            border: 2px solid #fff;
            position: relative;
        }

        /* === 1. é¦–é¡µ === */
        #home-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
            z-index: 10;
        }

        h2 { margin: 0 0 30px 0; color: #455A64; font-size: 32px; font-weight: 800; letter-spacing: 2px; }

        /* é²œè‰³çš„å¤§æŒ‰é’® */
        .btn-big {
            display: block; width: 100%; padding: 20px; margin-bottom: 20px;
            border: none; border-radius: 20px;
            font-size: 20px; font-weight: bold; color: white;
            cursor: pointer; transition: transform 0.1s;
            position: relative; overflow: hidden;
        }
        .btn-big:active { transform: scale(0.96); }
        
        .btn-morning { background: var(--btn-red-bg); box-shadow: 0 8px 20px var(--btn-red-shadow); }
        .btn-study { background: var(--btn-green-bg); box-shadow: 0 8px 20px var(--btn-green-shadow); }
        .btn-settings { background: var(--btn-blue-bg); box-shadow: 0 8px 20px var(--btn-blue-shadow); margin-top: 30px;}

        /* === 2. è®¾ç½®å¼¹çª— === */
        #settings-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 999;
            align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        
        .settings-content { width: 400px; text-align: left; }
        .setting-group { margin-bottom: 20px; }
        .setting-group label { display: block; color: #546E7A; font-weight: bold; margin-bottom: 8px; font-size: 16px; }
        
        .input-box {
            width: 100%; padding: 12px; border: 2px solid #E0E0E0; border-radius: 12px;
            font-size: 18px; box-sizing: border-box; outline: none; color: #37474F; font-weight: bold;
            transition: border-color 0.3s;
        }
        .input-box:focus { border-color: #42A5F5; }

        .interval-row { display: flex; align-items: center; gap: 10px; }
        .interval-row span { color: #90A4AE; font-weight: bold; }

        .btn-save {
            background: var(--btn-green-bg); color: white; width: 100%; padding: 15px;
            border: none; border-radius: 15px; font-size: 18px; font-weight: bold; cursor: pointer;
            box-shadow: 0 5px 15px var(--btn-green-shadow);
        }
        .close-icon { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #999; }

        /* === 3. ç›‘æ§é¡µ (æ–°) === */
        #monitor-screen { display: none; width: 100%; height: 100%; position: relative; }

        #top-bar {
            position: absolute; top: 40px; left: 50%; transform: translateX(-50%);
            background: white; padding: 15px 40px; 
            border-radius: 60px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            white-space: nowrap; z-index: 5;
            display: flex; align-items: center; gap: 20px; /* Flexå¸ƒå±€ */
        }

        #status-text { font-size: 50px; font-weight: 900; color: #455A64; }

        /* === æ–°å¢ï¼šè¿›åº¦åœ†ç¯ === */
        .progress-container {
            position: relative; width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
        }
        
        /* è¿™é‡Œçš„ --p æ˜¯ç™¾åˆ†æ¯”å˜é‡ï¼Œé€šè¿‡ JS æ§åˆ¶ */
        .progress-ring {
            width: 100%; height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--c, #FF5252) var(--p, 0%), #EEE 0%);
            -webkit-mask: radial-gradient(transparent 55%, black 56%);
            mask: radial-gradient(transparent 55%, black 56%);
            transition: --p 0.1s; /* å¹³æ»‘è¿‡æ¸¡ */
        }
        
        .progress-icon {
            position: absolute; font-size: 24px;
        }
        
        .progress-percent {
            position: absolute; font-size: 12px; font-weight: bold; color: #666; top: 62px; width: 100%; text-align: center;
        }

        #bottom-area {
            position: absolute; bottom: 30px; width: 100%;
            display: flex; justify-content: space-between; padding: 0 40px; box-sizing: border-box; z-index: 5;
        }
        
        .left-controls { display: flex; gap: 15px; }

        .ctrl-btn {
            background: white; padding: 12px 25px; border-radius: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1); cursor: pointer; border: none;
            font-size: 18px; font-weight: bold; color: #546E7A;
            display: flex; align-items: center; gap: 8px; transition: transform 0.1s;
        }
        .ctrl-btn:active { transform: scale(0.95); }
        .paused-btn { background: #FFF9C4; border: 2px solid #FFB300; }
        
        #basket-card {
            background: white; padding: 10px 30px; border-radius: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 15px;
            border: 3px solid #FFF3E0;
        }
        #score-text { font-size: 40px; font-weight: 900; color: #FF9800; }

        canvas { display: block; width: 100%; height: 100%; }

    </style>
</head>
<body>

    <!-- 1. é¦–é¡µ -->
    <div id="home-screen">
        <div class="glass-card" style="width: 320px;">
            <h2>ğŸŒ³ ç­çº§ä¸°æ”¶æ—¶åˆ»</h2>
            <button class="btn-big btn-morning" onclick="startApp('morning')">â˜€ï¸ æ—©è¯»æ¨¡å¼</button>
            <button class="btn-big btn-study" onclick="startApp('study')">ğŸŒ™ è‡ªä¹ æ¨¡å¼</button>
            <button class="btn-big btn-settings" onclick="toggleSettings(true)">âš™ï¸ é«˜çº§è®¾ç½®</button>
        </div>
    </div>

    <!-- 2. è®¾ç½®å¼¹çª— -->
    <div id="settings-modal">
        <div class="glass-card settings-content">
            <span class="close-icon" onclick="toggleSettings(false)">Ã—</span>
            <h3 style="margin-top:0; color:#37474F; font-size:24px;">ğŸ› ï¸ è¯¾å ‚è®¾ç½®</h3>
            <div class="setting-group">
                <label>ğŸ¯ ç›®æ ‡åˆ†è´ (çµæ•åº¦ 0-1200)</label>
                <input type="number" class="input-box" id="inp-db" value="300">
            </div>
            <div class="setting-group">
                <label>â³ è¯¾ç¨‹æ—¶é•¿ (åˆ†é’Ÿ)</label>
                <input type="number" class="input-box" id="inp-time" value="40">
            </div>
            <div class="setting-group">
                <label>ğŸ æ‰è½ç§¯ç´¯æ—¶é—´ (ç§’)</label>
                <div class="interval-row">
                    <input type="number" class="input-box" id="inp-min-sec" value="60" min="1" style="text-align:center">
                    <span>è‡³</span>
                    <input type="number" class="input-box" id="inp-max-sec" value="120" min="1" style="text-align:center">
                </div>
                <div style="font-size:12px; color:#999; margin-top:5px;">* æœ‰æ•ˆéŸ³é‡æŒç»­ç´¯è®¡æ»¡è¯¥æ—¶é—´åæ‰è½</div>
            </div>
            <button class="btn-save" onclick="toggleSettings(false)">ä¿å­˜å¹¶å…³é—­</button>
        </div>
    </div>

    <!-- 3. ç›‘æ§é¡µ -->
    <div id="monitor-screen">
        <div id="top-bar">
            <!-- æ–°å¢ï¼šè¿›åº¦ç¯ -->
            <div class="progress-container">
                <div class="progress-ring" id="progress-ring" style="--p: 0%; --c: #FF5252;"></div>
                <span class="progress-icon" id="progress-icon">ğŸ</span>
                <span class="progress-percent" id="progress-text">0%</span>
            </div>

            <span id="status-text">å‡†å¤‡å¼€å§‹...</span>
        </div>

        <canvas id="hdCanvas"></canvas>

        <div id="bottom-area">
            <div class="left-controls">
                <button class="ctrl-btn" onclick="returnHome()" title="è¿”å›é¦–é¡µ"><span>ğŸ </span></button>
                <button class="ctrl-btn" onclick="toggleSettings(true)" title="é«˜çº§è®¾ç½®"><span>âš™ï¸</span></button>
                <button class="ctrl-btn" id="btn-pause" onclick="togglePause()">
                    <span id="icon-pause">â¸</span> <span id="text-pause">æš‚åœ</span>
                </button>
                <button class="ctrl-btn"><span>â³</span> <span id="timer">40:00</span></button>
            </div>
            <div id="basket-card">
                <span style="font-size:40px">ğŸ§º</span>
                <span id="score-text">0</span>
            </div>
        </div>
    </div>

    <script>
        // === å…¨å±€é…ç½® ===
        let config = {
            mode: 'morning', threshold: 300, duration: 40, maxDb: 1200,
            dropMin: 60, dropMax: 120
        };

        // === è¿è¡ŒçŠ¶æ€ ===
        let state = { 
            running: false, paused: false, score: 0, startTime: 0,
            pausedTime: 0, totalPausedDuration: 0,
            
            currentValidTime: 0, // å½“å‰ç§¯ç´¯çš„æœ‰æ•ˆæ—¶é—´(ms)
            targetValidTime: 0,  // ç›®æ ‡ç§¯ç´¯æ—¶é—´(ms)
            lastFrameTime: 0 
        };
        
        let audioCtx, analyser, dataArray;
        let fruits = [];
        let animationId;

        const COLORS = {
            trunk: '#8D6E63', trunkDark: '#5D4037',
            leaf: '#66BB6A', leafDark: '#43A047', leafLight: '#A5D6A7',
            apple: '#FF5252', pear: '#FBC02D'
        };

        const canvas = document.getElementById('hdCanvas');
        const ctx = canvas.getContext('2d');

        function resizeCanvas() {
            const dpr = window.devicePixelRatio || 1;
            canvas.width = window.innerWidth * dpr;
            canvas.height = window.innerHeight * dpr;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            state.width = window.innerWidth;
            state.height = window.innerHeight;
            ctx.scale(dpr, dpr);
        }
        window.onresize = resizeCanvas;

        // === äº¤äº’é€»è¾‘ ===
        function toggleSettings(show) {
            const modal = document.getElementById('settings-modal');
            modal.style.display = show ? 'flex' : 'none';
            if(!show) {
                config.threshold = parseInt(document.getElementById('inp-db').value);
                config.duration = parseInt(document.getElementById('inp-time').value);
                config.dropMin = parseInt(document.getElementById('inp-min-sec').value);
                config.dropMax = parseInt(document.getElementById('inp-max-sec').value);
            }
        }

        function startApp(mode) {
            config.mode = mode;
            config.threshold = parseInt(document.getElementById('inp-db').value);
            config.duration = parseInt(document.getElementById('inp-time').value);
            config.dropMin = parseInt(document.getElementById('inp-min-sec').value);
            config.dropMax = parseInt(document.getElementById('inp-max-sec').value);

            document.getElementById('home-screen').style.display = 'none';
            document.getElementById('monitor-screen').style.display = 'block';
            
            // è®¾ç½®UIé¢œè‰²å’Œå›¾æ ‡
            const ring = document.getElementById('progress-ring');
            const icon = document.getElementById('progress-icon');
            if(mode === 'morning') {
                ring.style.setProperty('--c', '#FF5252'); // çº¢ç¯
                icon.innerText = 'ğŸ';
            } else {
                ring.style.setProperty('--c', '#66BB6A'); // ç»¿ç¯
                icon.innerText = 'ğŸ';
            }

            resizeCanvas();
            initAudio();
        }

        function returnHome() {
            state.running = false;
            if(audioCtx) audioCtx.close();
            cancelAnimationFrame(animationId);
            location.reload();
        }

        function togglePause() {
            state.paused = !state.paused;
            const statusEl = document.getElementById('status-text');
            if (state.paused) {
                state.pausedTime = Date.now();
                statusEl.innerText = "â¸ å·²æš‚åœ";
                statusEl.style.color = "#999";
            } else {
                state.totalPausedDuration += (Date.now() - state.pausedTime);
                state.lastFrameTime = Date.now();
                statusEl.innerText = "â–¶ ç»§ç»­ç›‘æ§...";
            }
            updatePauseBtn();
        }

        function updatePauseBtn() {
            const btn = document.getElementById('btn-pause');
            const icon = document.getElementById('icon-pause');
            const text = document.getElementById('text-pause');
            if (state.paused) {
                icon.innerText = "â–¶"; text.innerText = "ç»§ç»­"; btn.classList.add('paused-btn');
            } else {
                icon.innerText = "â¸"; text.innerText = "æš‚åœ"; btn.classList.remove('paused-btn');
            }
        }

        // === éŸ³é¢‘ç³»ç»Ÿ ===
        async function initAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioCtx.createAnalyser();
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                analyser.fftSize = 512;
                dataArray = new Uint8Array(analyser.frequencyBinCount);

                state.running = true; state.paused = false; state.score = 0;
                document.getElementById('score-text').innerText = "0";
                fruits = [];
                state.startTime = Date.now(); 
                state.totalPausedDuration = 0;
                state.lastFrameTime = Date.now();
                
                resetDropTarget();
                
                loop();
            } catch (e) {
                alert("è¯·å…è®¸éº¦å…‹é£æƒé™"); returnHome();
            }
        }

        function resetDropTarget() {
            const randomSec = Math.random() * (config.dropMax - config.dropMin) + config.dropMin;
            state.targetValidTime = randomSec * 1000; 
            state.currentValidTime = 0;
            updateProgressUI(0);
        }

        function updateProgressUI(percent) {
            const ring = document.getElementById('progress-ring');
            const text = document.getElementById('progress-text');
            ring.style.setProperty('--p', percent + '%');
            text.innerText = Math.floor(percent) + '%';
        }

        // === ä¸»å¾ªç¯ ===
        function loop() {
            if(!state.running) return;
            const now = Date.now();
            const dt = now - state.lastFrameTime;
            state.lastFrameTime = now;

            analyser.getByteFrequencyData(dataArray);
            let sum = 0;
            for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
            let vol = Math.floor((sum / dataArray.length / 128) * 600);
            if(vol > config.maxDb) vol = config.maxDb;

            if (!state.paused) updateLogic(vol, now, dt);
            draw();
            animationId = requestAnimationFrame(loop);
        }

        function updateLogic(vol, now, dt) {
            let elapsed = (now - state.startTime - state.totalPausedDuration) / 1000;
            let remaining = Math.max(0, config.duration * 60 - elapsed);
            let m = Math.floor(remaining / 60).toString().padStart(2, '0');
            let s = Math.floor(remaining % 60).toString().padStart(2, '0');
            document.getElementById('timer').innerText = `${m}:${s}`;

            const statusEl = document.getElementById('status-text');
            let conditionMet = false;

            // æ ¸å¿ƒé€»è¾‘
            if (config.mode === 'morning') {
                // æ—©è¯»æ¨¡å¼ï¼šå¤§äºé˜ˆå€¼ = ç§¯ç´¯
                if (vol >= config.threshold) {
                    statusEl.innerText = "ğŸ”¥ å£°éŸ³æ´ªäº®ï¼ç§¯ç´¯ä¸­..."; 
                    statusEl.style.color = "#FF7043";
                    conditionMet = true;
                } else {
                    statusEl.innerText = "ğŸ’¤ å£°éŸ³å¤ªå°äº†..."; 
                    statusEl.style.color = "#90A4AE";
                }
            } else {
                // è‡ªä¹ æ¨¡å¼ï¼šå°äºé˜ˆå€¼ = ç§¯ç´¯ (é€»è¾‘æ­£ç¡®)
                if (vol < config.threshold) {
                    statusEl.innerText = "ğŸŒ¿ å®‰é™è‡ªä¹ ï¼Œæˆç†Ÿä¸­..."; 
                    statusEl.style.color = "#66BB6A";
                    conditionMet = true;
                } else {
                    statusEl.innerText = "ğŸ“¢ å¤ªåµäº†ï¼åœæ­¢ç”Ÿé•¿ï¼"; 
                    statusEl.style.color = "#EF5350";
                }
            }

            if (conditionMet) {
                // ç§¯ç´¯æœ‰æ•ˆæ—¶é—´
                state.currentValidTime += dt;
                
                // è®¡ç®—ç™¾åˆ†æ¯”
                let percent = (state.currentValidTime / state.targetValidTime) * 100;
                if(percent > 100) percent = 100;
                updateProgressUI(percent);

                if (state.currentValidTime >= state.targetValidTime) {
                    createFruit();
                    resetDropTarget();
                }
            }
            // å¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œè¿›åº¦åªæ˜¯æš‚åœï¼Œä¸é‡ç½®ï¼ŒUIä¿æŒä¸å˜
            
            updateFruits();
        }

        function createFruit() {
            const cx = state.width / 2;
            const cy = state.height; 
            fruits.push({
                x: cx + (Math.random() - 0.5) * 700, 
                y: cy - 400 - Math.random() * 200, 
                vy: 0, rot: Math.random() * 6,
                type: config.mode === 'morning' ? 'apple' : 'pear',
                bounced: false
            });
        }

        function updateFruits() {
            const groundY = state.height - 60;
            for (let i = fruits.length - 1; i >= 0; i--) {
                let f = fruits[i];
                f.vy += 0.5; f.y += f.vy; f.rot += 0.05;
                if (f.y >= groundY) {
                    if (!f.bounced) {
                        f.y = groundY; f.vy = -8 - Math.random() * 3; f.bounced = true;
                    } else {
                        state.score++; document.getElementById('score-text').innerText = state.score;
                        const card = document.getElementById('basket-card');
                        card.style.transform = "scale(1.1)";
                        setTimeout(() => card.style.transform = "scale(1)", 100);
                        fruits.splice(i, 1);
                    }
                }
            }
        }

        // === ç»˜å›¾å¼•æ“ ===
        function draw() {
            const w = state.width;
            const h = state.height;
            const cx = w / 2;
            const cy = h; 

            ctx.clearRect(0, 0, w, h);

            // æ ‘å¹²
            ctx.fillStyle = COLORS.trunk;
            ctx.beginPath();
            ctx.moveTo(cx - 70, cy);
            ctx.lineTo(cx - 50, cy - 480); 
            ctx.lineTo(cx + 50, cy - 480);
            ctx.lineTo(cx + 70, cy);
            ctx.fill();
            
            ctx.fillStyle = "rgba(0,0,0,0.1)";
            ctx.beginPath();
            ctx.moveTo(cx + 15, cy - 480);
            ctx.lineTo(cx + 50, cy - 480);
            ctx.lineTo(cx + 70, cy);
            ctx.lineTo(cx + 25, cy);
            ctx.fill();

            // æ ‘å† 
            let breath = 1 + Math.sin(Date.now()/600) * 0.01;
            ctx.save();
            ctx.translate(cx, cy - 500);
            ctx.scale(breath, breath);
            
            const clusters = [
                {x: -180, y: 80, r: 220}, 
                {x: 180, y: 80, r: 220},  
                {x: 0, y: -140, r: 250}   
            ];

            ctx.fillStyle = COLORS.leafDark;
            clusters.forEach(c => { ctx.beginPath(); ctx.arc(c.x, c.y, c.r, 0, Math.PI*2); ctx.fill(); });
            ctx.fillStyle = COLORS.leaf;
            clusters.forEach(c => { ctx.beginPath(); ctx.arc(c.x, c.y, c.r * 0.92, 0, Math.PI*2); ctx.fill(); });
            ctx.fillStyle = COLORS.leafLight;
            clusters.forEach(c => { ctx.beginPath(); ctx.ellipse(c.x - 50, c.y - 50, c.r/3, c.r/4, Math.PI/4, 0, Math.PI*2); ctx.fill(); });

            ctx.restore();

            // æœå®
            fruits.forEach(f => {
                ctx.save();
                ctx.translate(f.x, f.y);
                ctx.rotate(f.rot);
                ctx.fillStyle = f.type === 'apple' ? COLORS.apple : COLORS.pear;
                ctx.beginPath(); ctx.arc(0, 0, 28, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "rgba(255,255,255,0.6)";
                ctx.beginPath(); ctx.ellipse(-10, -10, 8, 10, Math.PI/4, 0, Math.PI*2); ctx.fill();
                ctx.strokeStyle = "rgba(0,0,0,0.1)"; ctx.lineWidth=1; ctx.stroke();
                ctx.fillStyle = "#66BB6A";
                ctx.beginPath(); ctx.ellipse(0, -28, 8, 12, Math.PI/3, 0, Math.PI*2); ctx.fill();
                ctx.restore();
            });
        }
    </script>
</body>
</html>